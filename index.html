<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Di√°rio de M√°quinas</title>
  <style>
    :root{
      --bg:#f6f7f9;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --primary:#2563eb;
      --danger:#dc2626;
      --ok:#16a34a;
      --warn:#d97706;
      --shadow: 0 10px 25px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--text);background:var(--bg)}
    header{background:#fff;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:80}
    .bar{max-width:1100px;margin:0 auto;padding:12px 14px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,#2563eb,#22c55e)}
    .brand h1{margin:0;font-size:16px}
    .brand small{display:block;color:var(--muted);font-size:12px;margin-top:2px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:7px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;color:var(--muted);max-width:55vw;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
    .pill b{color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:12px;box-shadow:var(--shadow)}
    h2{margin:0 0 10px;font-size:15px}
    .muted{color:var(--muted);font-size:12px;line-height:1.35}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    input,select,textarea{width:100%;padding:11px 10px;border:1px solid var(--line);border-radius:10px;font-size:14px;background:#fff;color:var(--text);outline:none}
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:720px){.row{grid-template-columns:1fr}}
    .btn{border:1px solid var(--line);background:#fff;color:var(--text);font-weight:800;padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .btn:active{transform:translateY(1px)}
    .rightBtns{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;margin-top:12px}
    @media(max-width:720px){.rightBtns{justify-content:stretch}.rightBtns .btn{width:100%}}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .badge{display:inline-flex;padding:4px 8px;border-radius:999px;font-size:11px;font-weight:900;border:1px solid var(--line);color:var(--muted);background:#fff}
    .badge.ok{border-color:#bbf7d0;background:#f0fdf4;color:var(--ok)}
    .badge.warn{border-color:#fed7aa;background:#fff7ed;color:var(--warn)}
    .badge.bad{border-color:#fecaca;background:#fef2f2;color:var(--danger)}
    .notice{border:1px solid var(--line);background:#fafafa;border-radius:12px;padding:10px;font-size:12px;color:var(--muted);line-height:1.35}
    .preview{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .preview img{width:120px;height:90px;object-fit:cover;border-radius:10px;border:1px solid var(--line)}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#111827;color:#fff;padding:10px 12px;border-radius:999px;font-size:12px;font-weight:900;display:none;z-index:200;max-width:92vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
    .tab{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;color:var(--muted);font-weight:900;font-size:12px;cursor:pointer}
    .tab.active{border-color:var(--primary);color:var(--primary);background:#eff6ff}
    table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fff}
    th,td{border-bottom:1px solid var(--line);padding:10px;font-size:12px;vertical-align:top;text-align:left}
    th{background:#fafafa;color:var(--muted)}
    tr:last-child td{border-bottom:none}

    /* HOME DO OPERADOR (Op√ß√£o B) */
    .homeGrid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    @media(max-width:900px){ .homeGrid{grid-template-columns:1fr} }
    .bigBtn{
      width:100%;
      text-align:left;
      padding:14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      box-shadow:var(--shadow);
    }
    .bigBtn:active{transform:translateY(1px)}
    .bigBtn .t{font-size:14px;font-weight:900;color:var(--text);margin-bottom:6px}
    .bigBtn .s{font-size:12px;color:var(--muted);line-height:1.35}
    .bigBtn.primary{border-color:#bfdbfe;background:#eff6ff}
    .bigBtn.ok{border-color:#bbf7d0;background:#f0fdf4}
    .bigBtn.warn{border-color:#fed7aa;background:#fff7ed}
    .bigBtn.bad{border-color:#fecaca;background:#fef2f2}
    .bigBtn[disabled]{opacity:.55;cursor:not-allowed}
    .page{display:none}
    .page.active{display:block}
    @media(max-width:720px){
      .page .card{min-height: calc(100vh - 150px);}
    }

    /* Modal */
    .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:300;align-items:center;justify-content:center;padding:14px}
    .modal{max-width:900px;width:100%;background:#fff;border-radius:14px;border:1px solid var(--line);box-shadow:var(--shadow);padding:14px;max-height:85vh;overflow:auto}
    .modalHead{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .x{cursor:pointer;border:1px solid var(--line);border-radius:10px;background:#fff;padding:8px 10px;font-weight:900}
  </style>
</head>

<body>
<header>
  <div class="bar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Di√°rio de M√°quinas</h1>
        <small>Sincronizado (Supabase) ‚Ä¢ Operador em p√°ginas (Home + Etapas)</small>
      </div>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <div class="pill">üë§ <b id="pillName">‚Äî</b></div>
      <button class="btn" id="btnLogout" style="display:none" type="button">Sair</button>
    </div>
  </div>
</header>

<div class="wrap">

  <!-- LOGIN -->
  <div class="card" id="viewLogin">
    <h2>Login</h2>
    <div class="row">
      <div>
        <label>Usu√°rio</label>
        <input id="loginUser" autocomplete="username" placeholder="ex.: op1 / admin"/>
      </div>
      <div>
        <label>Senha</label>
        <input id="loginPass" type="password" autocomplete="current-password" placeholder="sua senha"/>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Manter conectado</label>
        <select id="keepLogged">
          <option value="sim">Sim</option>
          <option value="nao">N√£o</option>
        </select>
      </div>
      <div class="muted" style="align-self:end">
        Dica: operador abre pelo link do seu site normal.
      </div>
    </div>
    <div class="rightBtns">
      <button class="btn primary" id="btnLogin" type="button">Entrar</button>
    </div>
    <div class="muted" id="connState">Conex√£o: ‚Äî</div>
  </div>

  <!-- OPERADOR -->
  <div id="viewOperator" style="display:none">

    <div class="card">
      <h2>Operador</h2>
      <div class="row">
        <div class="notice" id="opInfo">‚Äî</div>
        <div class="notice" id="opTurnInfo">‚Äî</div>
      </div>
    </div>

    <!-- HOME DO OPERADOR -->
    <div class="page" id="opHome">
      <div class="card">
        <h2>Home do Operador</h2>

        <div class="row">
          <div>
            <label>Data do di√°rio</label>
            <input id="opDate" type="date"/>
            <div class="muted" style="margin-top:6px" id="opHomeHint">‚Äî</div>
          </div>
          <div class="notice" id="opHomeStatus">
            ‚Äî
          </div>
        </div>

        <div class="homeGrid">
          <button class="bigBtn primary" id="goDemand" type="button">
            <div class="t">1) Definir Demanda</div>
            <div class="s" id="homeDemandTxt">‚Äî</div>
          </button>

          <button class="bigBtn" id="goStart" type="button">
            <div class="t">2) Iniciar Turno</div>
            <div class="s" id="homeStartTxt">‚Äî</div>
          </button>

          <button class="bigBtn" id="goEnd" type="button">
            <div class="t">3) Encerrar Turno</div>
            <div class="s" id="homeEndTxt">‚Äî</div>
          </button>
        </div>

        <div class="divider"></div>
        <div class="muted">Dica: clique na etapa, preencha, e finalize. Voc√™ volta pra Home automaticamente.</div>
      </div>
    </div>

    <!-- PAGE: DEMANDA -->
    <div class="page" id="pageDemand">
      <div class="card">
        <h2>Demanda</h2>

        <div class="row">
          <div>
            <label>Usar demanda anterior?</label>
            <select id="usePrevDemand">
              <option value="sim">Sim</option>
              <option value="nao">N√£o (nova)</option>
            </select>
          </div>
          <div>
            <label>Status</label>
            <div class="muted" id="demandStatus">‚Äî</div>
            <button class="btn danger" type="button" id="btnCloseRental" style="display:none; margin-top:8px">Encerrar loca√ß√£o</button>
          </div>
        </div>

        <div id="prevDemandBox" class="notice" style="display:none; margin-top:10px">
          <div><b>Demanda anterior:</b> <span id="prevDemandText">‚Äî</span></div>
          <div class="rightBtns" style="justify-content:flex-start">
            <button class="btn" type="button" id="btnUsePrev">Usar anterior</button>
            <button class="btn" type="button" id="btnNewDemand">Nova demanda</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div>
            <label>Tipo</label>
            <select id="demandType">
              <option value="">Selecione</option>
              <option value="obra">Obra</option>
              <option value="locacao">Loca√ß√£o</option>
            </select>
          </div>
          <div>
            <label>Resumo</label>
            <div class="muted" id="demandSummary">‚Äî</div>
          </div>
        </div>

        <div id="demandObra" style="display:none">
          <div class="row">
            <div>
              <label>Nome da obra</label>
              <input id="obraName" placeholder="ex.: UFV Cl√°udio I"/>
            </div>
            <div>
              <label>Localiza√ß√£o</label>
              <input id="obraLocation" placeholder="ex.: Cl√°udio/MG"/>
            </div>
          </div>
        </div>

        <div id="demandLocacao" style="display:none">
          <div class="row">
            <div>
              <label>Cliente</label>
              <input id="locClient" placeholder="ex.: Cliente X"/>
            </div>
            <div>
              <label>Localiza√ß√£o</label>
              <input id="locLocation" placeholder="ex.: Curvelo/MG"/>
            </div>
          </div>
        </div>

        <div class="rightBtns">
          <button class="btn" type="button" id="btnBackHome1">Voltar (Home)</button>
          <button class="btn primary" type="button" id="btnSaveDemand">Salvar Demanda</button>
        </div>

        <div class="muted" style="margin-top:8px">Ao salvar, volta pra Home automaticamente ‚úÖ</div>
      </div>
    </div>

    <!-- PAGE: IN√çCIO -->
    <div class="page" id="pageStart">
      <div class="card">
        <h2>In√≠cio do turno</h2>

        <div class="notice" id="startHint">‚Äî</div>

        <div class="row">
          <div>
            <label>Hor√≠metro inicial</label>
            <input id="hm_start" type="number" step="0.1" placeholder="ex.: 5234.6"/>
          </div>
          <div>
            <label>Foto do hor√≠metro inicial</label>
            <input id="hm_start_photo" type="file" accept="image/*" capture="environment"/>
            <div class="preview" id="hm_start_preview"></div>
          </div>
        </div>

        <div class="divider"></div>

        <h2>Checklist</h2>
        <div class="row">
          <div><label>√ìleo motor</label><select id="ck_oil"><option>OK</option><option>Aten√ß√£o</option><option>Ruim</option></select></div>
          <div><label>√Ågua / arrefecimento</label><select id="ck_cool"><option>OK</option><option>Aten√ß√£o</option><option>Ruim</option></select></div>
          <div><label>√ìleo hidr√°ulico</label><select id="ck_hyd"><option>OK</option><option>Aten√ß√£o</option><option>Ruim</option></select></div>
          <div><label>Vazamentos</label><select id="ck_leak"><option>OK</option><option>Aten√ß√£o</option><option>Ruim</option></select></div>
          <div><label>Filtro de ar</label><select id="ck_air"><option>OK</option><option>Aten√ß√£o</option><option>Ruim</option></select></div>
          <div><label>Esteira / pneus</label><select id="ck_track"><option>OK</option><option>Aten√ß√£o</option><option>Ruim</option></select></div>
          <div><label>Painel / alertas</label><select id="ck_panel"><option>OK</option><option>Aten√ß√£o</option><option>Ruim</option></select></div>
          <div><label>Itens de seguran√ßa</label><select id="ck_safe"><option>OK</option><option>Aten√ß√£o</option><option>Ruim</option></select></div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div>
            <label>Teve avaria?</label>
            <select id="hasAvaria">
              <option value="nao">N√£o</option>
              <option value="sim">Sim</option>
            </select>
          </div>
          <div>
            <label>Categoria</label>
            <select id="av_cat" disabled>
              <option value="hidraulico">Hidr√°ulico</option>
              <option value="motor">Motor</option>
              <option value="eletrica">El√©trica</option>
              <option value="estrutura">Estrutura</option>
              <option value="trem_forca">Trem de for√ßa</option>
              <option value="implemento">Implemento</option>
              <option value="outro">Outro</option>
            </select>
          </div>
        </div>

        <div id="avariaBlock" style="display:none">
          <div class="row">
            <div>
              <label>Gravidade</label>
              <select id="av_sev">
                <option value="leve">Leve</option>
                <option value="media">M√©dia</option>
                <option value="grave">Grave</option>
              </select>
            </div>
            <div>
              <label>A m√°quina pode operar?</label>
              <select id="av_can">
                <option value="sim">Sim</option>
                <option value="restricao">Com restri√ß√£o</option>
                <option value="nao">N√£o</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Avaria j√° vinha de antes?</label>
              <select id="av_prev">
                <option value="nao">N√£o</option>
                <option value="sim">Sim</option>
              </select>
            </div>
            <div>
              <label>Foto da avaria</label>
              <input id="av_photo" type="file" accept="image/*" capture="environment"/>
              <div class="preview" id="av_preview"></div>
            </div>
          </div>

          <label>Descri√ß√£o (obrigat√≥ria)</label>
          <textarea id="av_desc" placeholder="Descreva o problema, sintomas, quando come√ßou..."></textarea>
        </div>

        <div class="divider"></div>
        <label>Observa√ß√µes do in√≠cio do turno</label>
        <textarea id="start_notes"></textarea>

        <div class="rightBtns">
          <button class="btn" type="button" id="btnBackHome2">Voltar (Home)</button>
          <button class="btn primary" type="button" id="btnStartShift">INICIAR TURNO</button>
        </div>
        <div class="muted" style="margin-top:8px">Ao iniciar, volta pra Home automaticamente ‚úÖ</div>
      </div>
    </div>

    <!-- PAGE: ENCERRAMENTO -->
    <div class="page" id="pageEnd">
      <div class="card">
        <h2>Encerramento do turno</h2>
        <div class="notice" id="endHint">‚Äî</div>

        <div class="row">
          <div>
            <label>Hor√≠metro final</label>
            <input id="hm_end" type="number" step="0.1" disabled/>
          </div>
          <div>
            <label>Foto do hor√≠metro final</label>
            <input id="hm_end_photo" type="file" accept="image/*" capture="environment" disabled/>
            <div class="preview" id="hm_end_preview"></div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Horas trabalhadas (auto)</label>
            <input id="hrs_worked" disabled/>
          </div>
          <div>
            <label>Horas paradas</label>
            <input id="hrs_stopped" type="number" step="0.1" value="0" disabled/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Motivo da parada</label>
            <select id="stop_reason" disabled>
              <option value="">‚Äî</option>
              <option value="manutencao">Manuten√ß√£o</option>
              <option value="chuva">Chuva</option>
              <option value="aguardando">Aguardando servi√ßo</option>
              <option value="falta_material">Falta de material</option>
              <option value="transporte">Transporte / mobiliza√ß√£o</option>
              <option value="outro">Outro</option>
            </select>
          </div>
          <div>
            <label>Detalhe</label>
            <input id="stop_detail" disabled/>
          </div>
        </div>

        <label>Observa√ß√µes do dia</label>
        <textarea id="day_notes" disabled></textarea>

        <div class="divider"></div>

        <h2>Abastecimento</h2>
        <div class="row">
          <div>
            <label>Abasteceu hoje?</label>
            <select id="fuel_yes" disabled>
              <option value="nao">N√£o</option>
              <option value="sim">Sim</option>
            </select>
          </div>
          <div>
            <label>Tipo</label>
            <select id="fuel_type" disabled>
              <option value="diesel">Diesel</option>
              <option value="gasolina">Gasolina</option>
              <option value="arla">ARLA</option>
            </select>
          </div>
        </div>

        <div id="fuelBlock" style="display:none">
          <div class="row">
            <div>
              <label>Litros</label>
              <input id="fuel_liters" type="number" step="0.1" disabled/>
            </div>
            <div>
              <label>Valor total (R$)</label>
              <input id="fuel_total" type="number" step="0.01" disabled/>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Pre√ßo por litro (auto)</label>
              <input id="fuel_price" disabled/>
            </div>
            <div>
              <label>Consumo aprox. (L/h) (auto)</label>
              <input id="fuel_lph" disabled/>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Quem abasteceu?</label>
              <select id="fuel_who" disabled>
                <option value="operador">Operador</option>
                <option value="outro">Outro</option>
              </select>
            </div>
            <div>
              <label>Foto nota/cupom</label>
              <input id="fuel_photo" type="file" accept="image/*" capture="environment" disabled/>
              <div class="preview" id="fuel_preview"></div>
            </div>
          </div>
        </div>

        <div class="rightBtns">
          <button class="btn" type="button" id="btnBackHome3">Voltar (Home)</button>
          <button class="btn primary" type="button" id="btnFinishShift" disabled>ENCERRAR TURNO</button>
        </div>
        <div class="muted" style="margin-top:8px">Ao encerrar, volta pra Home automaticamente ‚úÖ</div>
      </div>
    </div>

  </div>

  <!-- ADMIN -->
  <div id="viewAdmin" style="display:none">

    <div class="card">
      <h2>Admin</h2>
      <div class="tabs">
        <div class="tab active" data-tab="dash">Dashboard</div>
        <div class="tab" data-tab="machines">M√°quinas</div>
        <div class="tab" data-tab="users">Operadores / Logins</div>
        <div class="tab" data-tab="records">Registros</div>
        <div class="tab" data-tab="export">Exportar</div>
      </div>
      <div class="rightBtns" style="justify-content:flex-start">
        <button class="btn primary" type="button" id="btnForceRefresh">Atualizar do banco</button>
      </div>
      <div class="muted" id="adminConn">Conex√£o: ‚Äî</div>
    </div>

    <!-- DASH -->
    <div class="card" id="ad_dash">
      <h2>Status das m√°quinas (hoje)</h2>
      <div style="overflow:auto">
        <table>
          <thead>
          <tr>
            <th>M√°quina</th>
            <th>Status</th>
            <th>Operador</th>
            <th>Hor√≠metro</th>
            <th>Demanda</th>
          </tr>
          </thead>
          <tbody id="mach_status_body"></tbody>
        </table>
      </div>

      <div class="divider"></div>

      <h2>Resumo (per√≠odo)</h2>
      <div class="row">
        <div><label>De</label><input id="ad_from" type="date"/></div>
        <div><label>At√©</label><input id="ad_to" type="date"/></div>
      </div>
      <div class="rightBtns" style="justify-content:flex-start">
        <button class="btn primary" type="button" id="btnRefreshAdmin">Atualizar</button>
      </div>

      <div class="divider"></div>
      <div class="row">
        <div class="notice"><b>Horas trabalhadas:</b> <span id="kpi_hours">0.0</span></div>
        <div class="notice"><b>Abastecimento (L):</b> <span id="kpi_liters">0.0</span></div>
      </div>
      <div class="row">
        <div class="notice"><b>Avarias graves:</b> <span id="kpi_grave">0</span></div>
        <div class="notice"><b>M√°quinas sem di√°rio hoje:</b> <span id="kpi_sem">0</span></div>
      </div>
    </div>

    <!-- MACHINES -->
    <div class="card" id="ad_machines" style="display:none">
      <h2>M√°quinas</h2>
      <div class="row">
        <div>
          <label>Nome / Apelido</label>
          <input id="m_name" placeholder="ex.: Trator esteira D7"/>
        </div>
        <div>
          <label>Tipo</label>
          <input id="m_type" placeholder="ex.: trator / motoniveladora / escavadeira"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Marca/Modelo</label>
          <input id="m_model" placeholder="ex.: New Holland 7D"/>
        </div>
        <div>
          <label>Status</label>
          <select id="m_status">
            <option value="disponivel">Dispon√≠vel</option>
            <option value="operando">Operando</option>
            <option value="parada">Parada</option>
            <option value="manutencao">Manuten√ß√£o</option>
            <option value="locada">Locada</option>
          </select>
        </div>
      </div>
      <label>Observa√ß√µes</label>
      <textarea id="m_notes"></textarea>

      <div class="rightBtns">
        <button class="btn" id="btnMachineClear" type="button">Limpar</button>
        <button class="btn primary" id="btnMachineSave" type="button">Salvar m√°quina</button>
      </div>

      <div class="divider"></div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Nome</th>
              <th>Tipo</th>
              <th>Modelo</th>
              <th>Status</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="machines_body"></tbody>
        </table>
      </div>
      <div class="muted">Tudo aqui fica no banco (sincroniza).</div>
    </div>

    <!-- USERS -->
    <div class="card" id="ad_users" style="display:none">
      <h2>Operadores / Logins</h2>

      <div class="row">
        <div>
          <label>Nome</label>
          <input id="u_name" placeholder="ex.: Wesley"/>
        </div>
        <div>
          <label>Usu√°rio (login)</label>
          <input id="u_user" placeholder="ex.: op_wesley (ou telefone)"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Senha</label>
          <input id="u_pass" type="password" placeholder="defina a senha"/>
        </div>
        <div>
          <label>Perfil</label>
          <select id="u_role">
            <option value="operator">Operador</option>
            <option value="admin">Admin</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Ativo?</label>
          <select id="u_active">
            <option value="true">Ativo</option>
            <option value="false">Inativo</option>
          </select>
        </div>
        <div>
          <label>M√°quina vinculada (operador)</label>
          <select id="u_machine"></select>
        </div>
      </div>

      <div class="rightBtns">
        <button class="btn" type="button" id="btnUserClear">Limpar</button>
        <button class="btn primary" type="button" id="btnUserSave">Salvar usu√°rio</button>
      </div>

      <div class="divider"></div>

      <div style="overflow:auto">
        <table>
          <thead>
          <tr>
            <th>Nome</th>
            <th>Usu√°rio</th>
            <th>Perfil</th>
            <th>Ativo</th>
            <th>M√°quina</th>
            <th>A√ß√µes</th>
          </tr>
          </thead>
          <tbody id="users_body"></tbody>
        </table>
      </div>
      <div class="muted">Logins no banco (sincroniza).</div>
    </div>

    <!-- RECORDS -->
    <div class="card" id="ad_records" style="display:none">
      <h2>Registros</h2>
      <div class="row">
        <div><label>De</label><input id="rep_from" type="date"/></div>
        <div><label>At√©</label><input id="rep_to" type="date"/></div>
      </div>
      <div class="rightBtns" style="justify-content:flex-start">
        <button class="btn primary" type="button" id="btnApplyFilters">Aplicar</button>
      </div>

      <div class="divider"></div>

      <div style="overflow:auto">
        <table>
          <thead>
          <tr>
            <th>Data</th>
            <th>M√°quina</th>
            <th>Operador</th>
            <th>Demanda</th>
            <th>Horas</th>
            <th>Abast.</th>
            <th>Avaria</th>
            <th>A√ß√µes</th>
          </tr>
          </thead>
          <tbody id="rep_body"></tbody>
        </table>
      </div>
    </div>

    <!-- EXPORT -->
    <div class="card" id="ad_export" style="display:none">
      <h2>Exportar</h2>
      <div class="rightBtns" style="justify-content:flex-start">
        <button class="btn primary" type="button" id="btnExportCSV">Exportar CSV</button>
      </div>
      <div class="muted">Exporta os registros do banco.</div>
    </div>

  </div>

</div>

<!-- MODAL -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="modalHead">
      <div>
        <b id="modalTitle">Detalhes</b>
        <div class="muted" id="modalSub"></div>
      </div>
      <button class="x" id="btnModalClose" type="button">Fechar</button>
    </div>
    <div class="divider"></div>
    <div id="modalBody"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* =======================
   SUPABASE CONFIG (SEU)
   ======================= */
const SUPABASE_URL = "https://gcfrpuaalryjrkjfgppe.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_4jtV6I_Ihuos3r54n3x0kg_Xw34yyza";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =======================
   HELPERS
   ======================= */
function $(id){ return document.getElementById(id); }
function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}
function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(toast._timer);
  toast._timer = setTimeout(()=>t.style.display="none", 2200);
}
function todayStr(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}
function nowISO(){ return new Date().toISOString(); }
function normalizeLogin(s){
  return String(s || "")
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g,"")
    .replace(/\s+/g,"")
    .trim();
}
function genId(){
  if (crypto?.randomUUID) return crypto.randomUUID();
  return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}
async function fileToCompressedDataURL(file, maxW=900, quality=0.6){
  if(!file) return null;
  const img = new Image();
  const url = URL.createObjectURL(file);
  img.src = url;
  await img.decode();

  let w = img.width, h = img.height;
  const ratio = Math.min(1, maxW / w);
  w = Math.round(w * ratio);
  h = Math.round(h * ratio);

  const canvas = document.createElement("canvas");
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(img, 0, 0, w, h);
  URL.revokeObjectURL(url);

  return canvas.toDataURL("image/jpeg", quality);
}
function showPreview(containerId, dataURL){
  const box = $(containerId);
  box.innerHTML = "";
  if(!dataURL) return;
  const im = document.createElement("img");
  im.src = dataURL;
  box.appendChild(im);
}

/* =======================
   SESSION (local)
   ======================= */
const LS_SESSION = "diario_session_supabase_v1";
let session = { username:null, role:null };

function saveSession(){ localStorage.setItem(LS_SESSION, JSON.stringify(session)); }
function loadSession(){
  const raw = localStorage.getItem(LS_SESSION);
  if(!raw) return null;
  try { return JSON.parse(raw); } catch(e){ return null; }
}
function clearSession(){ localStorage.removeItem(LS_SESSION); }

/* =======================
   DB CACHE (mem√≥ria)
   ======================= */
let db = {
  machines: [],
  users: [],
  demandByUser: {},
  rentals: [],
  drafts: {},
  records: []
};

function draftKey(username, date){ return `${username}__${date}`; }
function machineName(id){
  if(!id) return "‚Äî";
  return db.machines.find(m=>m.id===id)?.name || "‚Äî";
}

/* =======================
   SUPABASE LOADERS
   ======================= */
async function pingSupabase(){
  const { error } = await sb.from("machines").select("id").limit(1);
  return !error;
}
async function loadMachines(){
  const { data, error } = await sb.from("machines").select("*").order("created_at", {ascending:true});
  if(error) throw error;
  db.machines = data || [];
}
async function loadUsers(){
  const { data, error } = await sb.from("users").select("*").order("created_at", {ascending:true});
  if(error) throw error;
  db.users = data || [];
}
async function loadDemandFor(username){
  const { data, error } = await sb.from("demands").select("*").eq("username", username).maybeSingle();
  if(error) throw error;
  db.demandByUser[username] = data ? {
    type: data.type,
    obraName: data.obra_name || "",
    obraLocation: data.obra_location || "",
    client: data.client || "",
    location: data.location || "",
    lastUsedISO: data.last_used_at || nowISO()
  } : null;
}
async function loadActiveRentalFor(username){
  const { data, error } = await sb.from("rentals")
    .select("*")
    .eq("username", username)
    .eq("status", "ativa")
    .order("start_at", {ascending:false})
    .limit(1);
  if(error) throw error;
  return (data && data[0]) ? data[0] : null;
}
async function loadDraft(username, date){
  const { data, error } = await sb.from("drafts").select("*").eq("username", username).eq("date", date).maybeSingle();
  if(error) throw error;
  if(data?.data){
    db.drafts[draftKey(username,date)] = data.data;
    return data.data;
  }
  delete db.drafts[draftKey(username,date)];
  return null;
}
async function loadRecordsRange(from, to){
  const { data, error } = await sb.from("records")
    .select("*")
    .gte("date", from)
    .lte("date", to)
    .order("date", {ascending:true});
  if(error) throw error;
  db.records = data || [];
}

/* =======================
   SUPABASE WRITERS
   ======================= */
async function upsertDemand(username, d){
  const row = {
    username,
    type: d.type,
    obra_name: d.type==="obra" ? d.obraName : null,
    obra_location: d.type==="obra" ? d.obraLocation : null,
    client: d.type==="locacao" ? d.client : null,
    location: d.type==="locacao" ? d.location : null,
    last_used_at: new Date().toISOString()
  };
  const { error } = await sb.from("demands").upsert(row, { onConflict: "username" });
  if(error) throw error;
  db.demandByUser[username] = d;
}
async function ensureRentalIfLocacao(username, userMachineId, d){
  if(d.type!=="locacao") return;
  const r = await loadActiveRentalFor(username);
  if(r) return;
  const { error } = await sb.from("rentals").insert({
    username,
    machine_id: userMachineId || null,
    client: d.client,
    location: d.location,
    status: "ativa",
    start_at: new Date().toISOString()
  });
  if(error) throw error;
}
async function closeRental(username){
  const r = await loadActiveRentalFor(username);
  if(!r) return null;
  const { error } = await sb.from("rentals")
    .update({ status:"encerrada", end_at: new Date().toISOString() })
    .eq("id", r.id);
  if(error) throw error;
  return true;
}
async function saveDraft(username, date, draftData){
  const { error } = await sb.from("drafts").upsert({ username, date, data: draftData }, { onConflict: "username,date" });
  if(error) throw error;
  db.drafts[draftKey(username,date)] = draftData;
}
async function deleteDraft(username, date){
  const { error } = await sb.from("drafts").delete().eq("username", username).eq("date", date);
  if(error) throw error;
  delete db.drafts[draftKey(username,date)];
}
async function insertRecord(recordObj){
  const hours = Number(recordObj.hoursWorked || 0);
  const fuelLiters = recordObj.fuel?.yes ? Number(recordObj.fuel.liters||0) : 0;
  const avSev = recordObj.avaria ? recordObj.avaria.severity : null;

  const row = {
    id: recordObj.id || genId(),
    date: recordObj.date,
    created_at: new Date().toISOString(),
    username: recordObj.username,
    operator_name: recordObj.operatorName,
    machine_id: recordObj.machineId,
    machine_name: recordObj.machineName,
    hours_worked: Number.isFinite(hours) ? hours : 0,
    fuel_liters: Number.isFinite(fuelLiters) ? fuelLiters : 0,
    avaria_severity: avSev,
    data: recordObj
  };

  const { error } = await sb.from("records").insert(row);
  if(error) throw error;
}

/* =======================
   AUTH helpers (banco)
   ======================= */
function findUserByUsername(username){
  const nu = normalizeLogin(username);
  return db.users.find(u => normalizeLogin(u.username) === nu) || null;
}
function findUserById(id){ return db.users.find(u => u.id === id) || null; }
function findMachineById(id){ return db.machines.find(m => m.id === id) || null; }

/* =======================
   VIEWS
   ======================= */
function showLogin(){
  $("viewLogin").style.display = "";
  $("viewOperator").style.display = "none";
  $("viewAdmin").style.display = "none";
  $("btnLogout").style.display = "none";
  $("pillName").textContent = "‚Äî";
}
function showOperator(){
  $("viewLogin").style.display = "none";
  $("viewOperator").style.display = "";
  $("viewAdmin").style.display = "none";
  $("btnLogout").style.display = "";
}
function showAdmin(){
  $("viewLogin").style.display = "none";
  $("viewOperator").style.display = "none";
  $("viewAdmin").style.display = "";
  $("btnLogout").style.display = "";
}

/* =======================
   OPERADOR: NAVEGA√á√ÉO (Home + P√°ginas)
   ======================= */
function showOpPage(pageId){
  // pages: opHome, pageDemand, pageStart, pageEnd
  ["opHome","pageDemand","pageStart","pageEnd"].forEach(id=>{
    $(id).classList.toggle("active", id===pageId);
  });
  window.scrollTo({top:0, behavior:"smooth"});
}
function goHome(){
  showOpPage("opHome");
  updateHomeCards();
}
function goDemand(){ showOpPage("pageDemand"); }
function goStart(){ showOpPage("pageStart"); }
function goEnd(){ showOpPage("pageEnd"); }

/* =======================
   DEMANDA / LOCA√á√ÉO (UI)
   ======================= */
function formatDemand(d, activeRental){
  if(!d) return "‚Äî";
  if(d.type==="obra") return `OBRA: ${d.obraName || "?"} ‚Äî ${d.obraLocation || "?"}`;
  if(d.type==="locacao"){
    const st = activeRental ? "ATIVA" : "‚Äî";
    return `LOCA√á√ÉO (${st}): ${d.client || "?"} ‚Äî ${d.location || "?"}`;
  }
  return "‚Äî";
}
function demandFromUI(){
  const type = $("demandType").value;
  if(!type) return null;
  if(type==="obra"){
    return { type:"obra", obraName:$("obraName").value.trim(), obraLocation:$("obraLocation").value.trim(), lastUsedISO:nowISO() };
  }
  if(type==="locacao"){
    return { type:"locacao", client:$("locClient").value.trim(), location:$("locLocation").value.trim(), lastUsedISO:nowISO() };
  }
  return null;
}
function setDemandUI(d){
  $("demandType").value = d?.type || "";
  updateDemandTypeUI();
  if(d?.type==="obra"){
    $("obraName").value = d.obraName || "";
    $("obraLocation").value = d.obraLocation || "";
  }else if(d?.type==="locacao"){
    $("locClient").value = d.client || "";
    $("locLocation").value = d.location || "";
  }else{
    $("obraName").value = "";
    $("obraLocation").value = "";
    $("locClient").value = "";
    $("locLocation").value = "";
  }
  updateDemandSummary();
}
async function updateDemandTypeUI(){
  const t = $("demandType").value;
  $("demandObra").style.display = (t==="obra") ? "" : "none";
  $("demandLocacao").style.display = (t==="locacao") ? "" : "none";

  if(t==="locacao"){
    const r = await loadActiveRentalFor(session.username);
    if(r){
      $("btnCloseRental").style.display = "";
      $("demandStatus").innerHTML = `Loca√ß√£o: <span class="badge ok">ATIVA</span> ‚Ä¢ In√≠cio: <b>${esc(String(r.start_at).slice(0,10))}</b>`;
      $("locClient").value = r.client || $("locClient").value;
      $("locLocation").value = r.location || $("locLocation").value;
    }else{
      $("btnCloseRental").style.display = "none";
      $("demandStatus").innerHTML = `Loca√ß√£o: <span class="badge">Sem ativa</span>`;
    }
  }else{
    $("btnCloseRental").style.display = "none";
    $("demandStatus").textContent = "‚Äî";
  }
  updateDemandSummary();
}
function updateDemandSummary(){
  const saved = db.demandByUser[session.username] || null;
  const d = demandFromUI() || saved;
  $("demandSummary").innerHTML = `<b>Demanda atual:</b> ${esc(formatDemand(d, null))}`;
}
async function saveDemand(){
  const d = demandFromUI();
  if(!d){ toast("Selecione tipo de demanda"); return; }
  if(d.type==="obra"){
    if(!d.obraName || !d.obraLocation){ toast("Preencha nome e localiza√ß√£o da obra"); return; }
  }
  if(d.type==="locacao"){
    if(!d.client || !d.location){ toast("Preencha cliente e localiza√ß√£o"); return; }
  }

  await upsertDemand(session.username, d);

  const user = findUserByUsername(session.username);
  await ensureRentalIfLocacao(session.username, user?.machine_id, d);

  toast("Demanda salva (sincronizada) ‚úÖ");
  await updateDemandTypeUI();
  updateHomeCards();
  goHome();
}
async function closeRentalUI(){
  const ok = confirm("Encerrar a loca√ß√£o agora?");
  if(!ok) return;
  const done = await closeRental(session.username);
  if(!done){ toast("Nenhuma loca√ß√£o ativa"); return; }

  const current = db.demandByUser[session.username];
  if(current?.type==="locacao"){
    await sb.from("demands").delete().eq("username", session.username);
    db.demandByUser[session.username] = null;
  }

  $("demandType").value = "";
  setDemandUI(null);
  toast("Loca√ß√£o encerrada ‚úÖ");
  await updateDemandTypeUI();
  updateHomeCards();
}

/* =======================
   CHECKLIST / AVARIA
   ======================= */
function setAvariaEnabled(enabled){
  $("av_cat").disabled = !enabled;
  $("avariaBlock").style.display = enabled ? "" : "none";
  if(!enabled){
    $("av_desc").value = "";
    $("av_photo").value = "";
    $("av_preview").innerHTML = "";
  }
}
function checklistFromUI(){
  return {
    oil: $("ck_oil").value,
    cool: $("ck_cool").value,
    hyd: $("ck_hyd").value,
    leak: $("ck_leak").value,
    air: $("ck_air").value,
    track: $("ck_track").value,
    panel: $("ck_panel").value,
    safe: $("ck_safe").value,
  };
}
function avariaFromUI(photoDataURL){
  if($("hasAvaria").value !== "sim") return null;
  const desc = $("av_desc").value.trim();
  return {
    category: $("av_cat").value,
    severity: $("av_sev").value,
    canOperate: $("av_can").value,
    previous: $("av_prev").value,
    desc,
    photo: photoDataURL || null
  };
}

/* =======================
   START/END FLOW
   ======================= */
function enableEndFields(enabled){
  $("hm_end").disabled = !enabled;
  $("hm_end_photo").disabled = !enabled;
  $("hrs_stopped").disabled = !enabled;
  $("stop_reason").disabled = !enabled;
  $("stop_detail").disabled = !enabled;
  $("day_notes").disabled = !enabled;
  $("fuel_yes").disabled = !enabled;
  $("fuel_type").disabled = !enabled;
  $("fuel_liters").disabled = !enabled;
  $("fuel_total").disabled = !enabled;
  $("fuel_who").disabled = !enabled;
  $("fuel_photo").disabled = !enabled;
  $("btnFinishShift").disabled = !enabled;

  if(!enabled){
    $("fuelBlock").style.display = "none";
  }
}
function setFuelBlockVisible(){
  $("fuelBlock").style.display = ($("fuel_yes").value==="sim") ? "" : "none";
}
function calcHours(){
  const date = $("opDate").value;
  const d = db.drafts[draftKey(session.username, date)] || null;
  const s = Number(d?.hmStart ?? NaN);
  const e = Number($("hm_end").value);
  if(Number.isFinite(s) && Number.isFinite(e) && e >= s){
    $("hrs_worked").value = (e - s).toFixed(1);
  }else{
    $("hrs_worked").value = "";
  }
}
function calcFuel(){
  if($("fuel_yes").value !== "sim"){
    $("fuel_price").value = "";
    $("fuel_lph").value = "";
    return;
  }
  const liters = Number($("fuel_liters").value);
  const total = Number($("fuel_total").value);
  if(Number.isFinite(liters) && liters>0 && Number.isFinite(total) && total>0){
    $("fuel_price").value = (total/liters).toFixed(3);
  }else{
    $("fuel_price").value = "";
  }
  const hw = Number($("hrs_worked").value);
  if(Number.isFinite(liters) && liters>0 && Number.isFinite(hw) && hw>0){
    $("fuel_lph").value = (liters/hw).toFixed(2);
  }else{
    $("fuel_lph").value = "";
  }
}
function lockStartFields(lock){
  $("hm_start").disabled = lock;
  $("hm_start_photo").disabled = lock;
  $("btnStartShift").disabled = lock;

  $("ck_oil").disabled = lock;
  $("ck_cool").disabled = lock;
  $("ck_hyd").disabled = lock;
  $("ck_leak").disabled = lock;
  $("ck_air").disabled = lock;
  $("ck_track").disabled = lock;
  $("ck_panel").disabled = lock;
  $("ck_safe").disabled = lock;

  $("hasAvaria").disabled = lock;
  $("av_sev").disabled = lock;
  $("av_can").disabled = lock;
  $("av_prev").disabled = lock;
  $("av_photo").disabled = lock;
  $("av_desc").disabled = lock;
  $("av_cat").disabled = lock || ($("hasAvaria").value !== "sim");

  $("start_notes").disabled = lock;
}
function resetStartFields(){
  $("hm_start").value = "";
  $("hm_start_photo").value = "";
  $("hm_start_preview").innerHTML = "";

  $("ck_oil").value="OK"; $("ck_cool").value="OK"; $("ck_hyd").value="OK"; $("ck_leak").value="OK";
  $("ck_air").value="OK"; $("ck_track").value="OK"; $("ck_panel").value="OK"; $("ck_safe").value="OK";

  $("hasAvaria").value="nao";
  setAvariaEnabled(false);

  $("start_notes").value="";
}
function resetEndFields(){
  $("hm_end").value="";
  $("hm_end_photo").value="";
  $("hm_end_preview").innerHTML="";
  $("hrs_worked").value="";
  $("hrs_stopped").value="0";
  $("stop_reason").value="";
  $("stop_detail").value="";
  $("day_notes").value="";
  $("fuel_yes").value="nao";
  $("fuel_type").value="diesel";
  $("fuel_liters").value="";
  $("fuel_total").value="";
  $("fuel_price").value="";
  $("fuel_lph").value="";
  $("fuel_who").value="operador";
  $("fuel_photo").value="";
  $("fuel_preview").innerHTML="";
  $("fuelBlock").style.display="none";
}
function updateTurnInfo(){
  const date = $("opDate").value;
  const d = db.drafts[draftKey(session.username, date)] || null;
  if(d){
    $("opTurnInfo").innerHTML =
      `<b>Turno:</b> <span class="badge ok">RODANDO</span><br>` +
      `<b>In√≠cio:</b> ${esc(String(d.startedAtISO).slice(0,16).replace("T"," "))}<br>` +
      `<b>Hor√≠metro inicial:</b> ${esc(d.hmStart)}`;
    $("endHint").innerHTML = `Turno iniciado. Preencha no fim do dia e clique <b>ENCERRAR TURNO</b>.`;
  }else{
    $("opTurnInfo").innerHTML =
      `<b>Turno:</b> <span class="badge">N√ÉO INICIADO</span><br>` +
      `Inicie o turno na etapa "Iniciar Turno".`;
    $("endHint").innerHTML = `Inicie o turno primeiro para liberar esta etapa.`;
  }
  updateHomeCards();
}

async function startShift(){
  const date = $("opDate").value;
  if(!date){ toast("Selecione a data na Home"); goHome(); return; }

  const user = findUserByUsername(session.username);
  if(!user || !user.active){ toast("Usu√°rio inativo"); logout(); return; }
  if(!user.machine_id){ toast("Admin precisa vincular uma m√°quina ao seu login"); goHome(); return; }

  const saved = db.demandByUser[session.username] || null;
  const d = demandFromUI() || saved;
  if(!d){ toast("Defina e salve a demanda"); goHome(); return; }
  if(d.type==="obra" && (!d.obraName || !d.obraLocation)){ toast("Demanda de obra incompleta"); goHome(); return; }
  if(d.type==="locacao" && (!d.client || !d.location)){ toast("Demanda de loca√ß√£o incompleta"); goHome(); return; }

  await upsertDemand(session.username, d);
  await ensureRentalIfLocacao(session.username, user.machine_id, d);

  const hmStart = Number($("hm_start").value);
  if(!Number.isFinite(hmStart)){ toast("Preencha hor√≠metro inicial"); return; }

  let hmStartPhoto = null;
  const f = $("hm_start_photo").files?.[0] || null;
  if(f) hmStartPhoto = await fileToCompressedDataURL(f);

  let avPhoto = null;
  if($("hasAvaria").value === "sim"){
    const desc = $("av_desc").value.trim();
    if(!desc){ toast("Descreva a avaria"); return; }
    const af = $("av_photo").files?.[0] || null;
    if(af) avPhoto = await fileToCompressedDataURL(af);
  }

  const draft = {
    id: genId(),
    date,
    startedAtISO: nowISO(),
    username: session.username,
    operatorName: user.name,
    machineId: user.machine_id,
    machineName: machineName(user.machine_id),
    demand: d,
    hmStart,
    hmStartPhoto,
    checklist: checklistFromUI(),
    avaria: avariaFromUI(avPhoto),
    startNotes: $("start_notes").value.trim()
  };

  await saveDraft(session.username, date, draft);

  lockStartFields(true);
  enableEndFields(true);
  updateTurnInfo();
  toast("Turno iniciado ‚úÖ (sincronizado)");
  goHome();
}

async function finishShift(){
  const date = $("opDate").value;
  const draft = db.drafts[draftKey(session.username, date)] || null;
  if(!draft){ toast("Inicie o turno primeiro"); goHome(); return; }

  const hmEnd = Number($("hm_end").value);
  if(!Number.isFinite(hmEnd)){ toast("Preencha hor√≠metro final"); return; }
  if(hmEnd < draft.hmStart){ toast("Hor√≠metro final n√£o pode ser menor que o inicial"); return; }

  let hmEndPhoto = null;
  const f = $("hm_end_photo").files?.[0] || null;
  if(f) hmEndPhoto = await fileToCompressedDataURL(f);

  calcHours();
  const hoursWorked = Number($("hrs_worked").value || 0);

  setFuelBlockVisible();
  calcFuel();
  let fuelPhoto = null;
  if($("fuel_yes").value === "sim"){
    const liters = Number($("fuel_liters").value);
    const total = Number($("fuel_total").value);
    if(!Number.isFinite(liters) || liters<=0){ toast("Informe litros"); return; }
    if(!Number.isFinite(total) || total<=0){ toast("Informe valor total"); return; }
    const fu = $("fuel_photo").files?.[0] || null;
    if(fu) fuelPhoto = await fileToCompressedDataURL(fu);
  }

  const record = {
    id: genId(),
    date,
    createdAtISO: nowISO(),
    username: draft.username,
    operatorName: draft.operatorName,
    machineId: draft.machineId,
    machineName: draft.machineName,
    demand: draft.demand,

    hmStart: draft.hmStart,
    hmStartPhoto: draft.hmStartPhoto,
    checklist: draft.checklist,
    avaria: draft.avaria,
    startNotes: draft.startNotes,

    hmEnd,
    hmEndPhoto,
    hoursWorked,
    hoursStopped: Number($("hrs_stopped").value || 0),
    stopReason: $("stop_reason").value,
    stopDetail: $("stop_detail").value.trim(),
    dayNotes: $("day_notes").value.trim(),

    fuel: ($("fuel_yes").value === "sim") ? {
      yes:true,
      type: $("fuel_type").value,
      who: $("fuel_who").value,
      liters: Number($("fuel_liters").value),
      total: Number($("fuel_total").value),
      pricePerLiter: Number($("fuel_price").value),
      lph: Number($("fuel_lph").value),
      photo: fuelPhoto
    } : { yes:false }
  };

  await insertRecord(record);
  await deleteDraft(session.username, date);

  toast("Turno encerrado ‚úÖ (sincronizado)");

  lockStartFields(false);
  enableEndFields(false);
  resetStartFields();
  resetEndFields();
  updateTurnInfo();
  goHome();
}

/* =======================
   LOAD DRAFT INTO UI
   ======================= */
async function loadDraftToUIIfExists(){
  const date = $("opDate").value;
  const draft = await loadDraft(session.username, date);

  if(!draft){
    lockStartFields(false);
    enableEndFields(false);
    resetStartFields();
    resetEndFields();
    updateTurnInfo();
    $("startHint").innerHTML = `Preencha os dados do in√≠cio e clique <b>INICIAR TURNO</b>.`;
    return;
  }

  $("hm_start").value = draft.hmStart;
  showPreview("hm_start_preview", draft.hmStartPhoto);

  $("ck_oil").value = draft.checklist.oil;
  $("ck_cool").value = draft.checklist.cool;
  $("ck_hyd").value = draft.checklist.hyd;
  $("ck_leak").value = draft.checklist.leak;
  $("ck_air").value = draft.checklist.air;
  $("ck_track").value = draft.checklist.track;
  $("ck_panel").value = draft.checklist.panel;
  $("ck_safe").value = draft.checklist.safe;

  if(draft.avaria){
    $("hasAvaria").value="sim";
    setAvariaEnabled(true);
    $("av_cat").value = draft.avaria.category;
    $("av_sev").value = draft.avaria.severity;
    $("av_can").value = draft.avaria.canOperate;
    $("av_prev").value = draft.avaria.previous;
    $("av_desc").value = draft.avaria.desc;
    showPreview("av_preview", draft.avaria.photo);
  }else{
    $("hasAvaria").value="nao";
    setAvariaEnabled(false);
  }

  $("start_notes").value = draft.startNotes || "";

  lockStartFields(true);
  enableEndFields(true);
  $("startHint").innerHTML = `Turno j√° foi iniciado hoje. Voc√™ pode ir para <b>Encerrar Turno</b> quando terminar.`;
  updateTurnInfo();
}

/* =======================
   HOME: STATUS + BOT√ïES
   ======================= */
function updateHomeCards(){
  const date = $("opDate").value;
  const dDraft = db.drafts[draftKey(session.username, date)] || null;
  const demSaved = db.demandByUser[session.username] || null;

  // Demanda
  $("homeDemandTxt").textContent = demSaved ? formatDemand(demSaved, null) : "Nenhuma demanda salva ainda.";

  // Turno (draft)
  if(dDraft){
    $("homeStartTxt").innerHTML = `Turno <b>RODANDO</b> ‚Ä¢ Iniciado: ${String(dDraft.startedAtISO).slice(11,16)} ‚Ä¢ Hor√≠metro: ${dDraft.hmStart}`;
  }else{
    $("homeStartTxt").textContent = "Turno ainda n√£o iniciado para esta data.";
  }

  // Encerramento
  if(dDraft){
    $("homeEndTxt").textContent = "Liberado: preencha e encerre quando terminar ‚úÖ";
  }else{
    $("homeEndTxt").textContent = "Bloqueado: inicie o turno primeiro.";
  }

  // Bot√µes: regras simples
  const hasDemand = !!demSaved;
  $("goStart").disabled = !hasDemand || !!dDraft;   // n√£o inicia se n√£o tem demanda; nem se j√° est√° rodando
  $("goEnd").disabled = !dDraft;                    // s√≥ encerra se tem draft

  // estilos dos cart√µes
  $("goDemand").className = "bigBtn primary";
  $("goStart").className = "bigBtn " + (dDraft ? "warn" : (hasDemand ? "ok" : "bad"));
  $("goEnd").className = "bigBtn " + (dDraft ? "ok" : "bad");

  // resumo geral
  let statusHTML = "";
  statusHTML += `<b>Demanda:</b> ${hasDemand ? `<span class="badge ok">OK</span>` : `<span class="badge bad">Falta</span>`}<br>`;
  statusHTML += `<b>Turno:</b> ${dDraft ? `<span class="badge ok">Rodando</span>` : `<span class="badge">N√£o iniciado</span>`}<br>`;
  statusHTML += `<b>Encerramento:</b> ${dDraft ? `<span class="badge warn">Pendente</span>` : `<span class="badge">‚Äî</span>`}`;
  $("opHomeStatus").innerHTML = statusHTML;

  // dica
  if(!hasDemand) $("opHomeHint").textContent = "Comece definindo a demanda do dia.";
  else if(!dDraft) $("opHomeHint").textContent = "Agora voc√™ pode iniciar o turno.";
  else $("opHomeHint").textContent = "Quando finalizar o dia, encerre o turno.";
}

/* =======================
   OPERATOR INIT
   ======================= */
async function initOperator(){
  await loadMachines();
  await loadUsers();
  await loadDemandFor(session.username);

  const user = findUserByUsername(session.username);
  $("opInfo").innerHTML =
    `<b>Operador:</b> ${esc(user.name)}<br><b>M√°quina:</b> ${esc(machineName(user.machine_id))}`;

  $("opDate").value = todayStr();

  const prev = db.demandByUser[session.username] || null;
  if(prev){
    $("prevDemandBox").style.display = "";
    $("prevDemandText").textContent = formatDemand(prev, null);
  }else{
    $("prevDemandBox").style.display = "none";
  }

  if($("usePrevDemand").value==="sim" && prev) setDemandUI(prev);
  else setDemandUI(null);

  await updateDemandTypeUI();
  updateDemandSummary();

  await loadDraftToUIIfExists();

  // abre home sempre
  showOpPage("opHome");
  updateHomeCards();
}

/* =======================
   ADMIN: TABS
   ======================= */
function setupAdminTabs(){
  const tabs = Array.from(document.querySelectorAll(".tab"));
  function showTab(tab){
    tabs.forEach(x=>x.classList.toggle("active", x.dataset.tab===tab));
    $("ad_dash").style.display = (tab==="dash") ? "" : "none";
    $("ad_machines").style.display = (tab==="machines") ? "" : "none";
    $("ad_users").style.display = (tab==="users") ? "" : "none";
    $("ad_records").style.display = (tab==="records") ? "" : "none";
    $("ad_export").style.display = (tab==="export") ? "" : "none";
  }
  tabs.forEach(t => t.onclick = async ()=> {
    showTab(t.dataset.tab);
    if(t.dataset.tab==="machines"){ await refreshAllAdminData(); renderMachinesTable(); fillMachineSelectForUsers(); }
    if(t.dataset.tab==="users"){ await refreshAllAdminData(); renderUsersTable(); fillMachineSelectForUsers(); }
    if(t.dataset.tab==="records"){ await renderRecordsTable(); }
    if(t.dataset.tab==="dash"){ await refreshAdmin(); }
  });
  showTab("dash");
}

/* =======================
   ADMIN: DASH
   ======================= */
async function machineStatusToday(){
  const today = todayStr();
  const { data: drafts, error: e1 } = await sb.from("drafts").select("*").eq("date", today);
  if(e1) throw e1;

  const { data: recs, error: e2 } = await sb.from("records").select("*").eq("date", today);
  if(e2) throw e2;

  const draftByMachine = new Map();
  (drafts||[]).forEach(row=>{
    const d = row.data;
    if(d?.machineId) draftByMachine.set(d.machineId, d);
  });

  const recordByMachine = new Map();
  (recs||[]).forEach(row=>{
    const r = row.data;
    if(r?.machineId) recordByMachine.set(r.machineId, r);
  });

  return db.machines.map(m=>{
    const d = draftByMachine.get(m.id) || null;
    const r = recordByMachine.get(m.id) || null;
    const stopByAvaria = (r?.avaria && r.avaria.canOperate==="nao") || (d?.avaria && d.avaria.canOperate==="nao");

    let status = { label:"Sem di√°rio", badge:"badge" };
    let operador = "‚Äî";
    let hor = "‚Äî";
    let dem = "‚Äî";

    if(d){
      status = { label: stopByAvaria ? "Parada" : "Rodando", badge: stopByAvaria ? "badge bad" : "badge ok" };
      operador = d.operatorName || "‚Äî";
      hor = `Ini: ${d.hmStart}`;
      dem = formatDemand(d.demand, null);
    } else if(r){
      status = { label: stopByAvaria ? "Parada" : "Encerrada hoje", badge: stopByAvaria ? "badge bad" : "badge warn" };
      operador = r.operatorName || "‚Äî";
      hor = `Ini: ${r.hmStart} ‚Ä¢ Fim: ${r.hmEnd}`;
      dem = formatDemand(r.demand, null);
    }
    return { machine:m.name, status, operador, hor, dem };
  });
}
async function renderMachineStatusTable(){
  const rows = await machineStatusToday();
  $("mach_status_body").innerHTML = rows.map(x=>`
    <tr>
      <td><b>${esc(x.machine)}</b></td>
      <td><span class="${esc(x.status.badge)}">${esc(x.status.label)}</span></td>
      <td>${esc(x.operador)}</td>
      <td>${esc(x.hor)}</td>
      <td>${esc(x.dem)}</td>
    </tr>
  `).join("");
}
async function refreshAdmin(){
  await loadMachines();
  await renderMachineStatusTable();

  const from = $("ad_from").value || "0000-01-01";
  const to = $("ad_to").value || "9999-12-31";
  await loadRecordsRange(from, to);

  let hours=0, liters=0, grave=0;
  db.records.forEach(row=>{
    hours += Number(row.hours_worked||0);
    liters += Number(row.fuel_liters||0);
    if(row.avaria_severity==="grave") grave++;
  });

  $("kpi_hours").textContent = hours.toFixed(1);
  $("kpi_liters").textContent = liters.toFixed(1);
  $("kpi_grave").textContent = String(grave);

  const today = todayStr();
  const { data: recToday } = await sb.from("records").select("machine_id").eq("date", today);
  const { data: drToday } = await sb.from("drafts").select("data").eq("date", today);

  const hasToday = new Set((recToday||[]).map(r=>r.machine_id).filter(Boolean));
  const hasDraftToday = new Set((drToday||[]).map(d=>d?.data?.machineId).filter(Boolean));

  const sem = db.machines.filter(m=> !hasToday.has(m.id) && !hasDraftToday.has(m.id)).length;
  $("kpi_sem").textContent = String(sem);
}

/* =======================
   ADMIN: MACHINES CRUD
   ======================= */
let editingMachineId = null;
function machineStatusLabel(s){
  const map = { disponivel:"Dispon√≠vel", operando:"Operando", parada:"Parada", manutencao:"Manuten√ß√£o", locada:"Locada" };
  return map[s] || s || "‚Äî";
}
function renderMachinesTable(){
  $("machines_body").innerHTML = db.machines.map(m=>`
    <tr>
      <td><b>${esc(m.name)}</b></td>
      <td>${esc(m.type||"‚Äî")}</td>
      <td>${esc(m.model||"‚Äî")}</td>
      <td><span class="badge">${esc(machineStatusLabel(m.status))}</span></td>
      <td>
        <button class="btn" type="button" onclick="editMachine('${m.id}')">Editar</button>
        <button class="btn danger" type="button" onclick="deleteMachine('${m.id}')">Excluir</button>
      </td>
    </tr>
  `).join("") || `<tr><td colspan="5" class="muted">Sem m√°quinas cadastradas.</td></tr>`;
}
function clearMachineForm(){
  editingMachineId = null;
  $("m_name").value="";
  $("m_type").value="";
  $("m_model").value="";
  $("m_status").value="disponivel";
  $("m_notes").value="";
}
function editMachine(id){
  const m = findMachineById(id);
  if(!m) return;
  editingMachineId = id;
  $("m_name").value = m.name || "";
  $("m_type").value = m.type || "";
  $("m_model").value = m.model || "";
  $("m_status").value = m.status || "disponivel";
  $("m_notes").value = m.notes || "";
  toast("Editando m√°quina");
}
async function deleteMachine(id){
  if(!confirm("Excluir esta m√°quina?")) return;
  const { error } = await sb.from("machines").delete().eq("id", id);
  if(error){ toast("Erro ao excluir"); console.error(error); return; }
  toast("M√°quina exclu√≠da");
  await loadMachines();
  renderMachinesTable();
  fillMachineSelectForUsers();
}
async function saveMachine(){
  const name = $("m_name").value.trim();
  if(!name){ toast("Informe o nome da m√°quina"); return; }

  const obj = {
    name,
    type: $("m_type").value.trim(),
    model: $("m_model").value.trim(),
    status: $("m_status").value,
    notes: $("m_notes").value.trim()
  };

  if(editingMachineId){
    const { error } = await sb.from("machines").update(obj).eq("id", editingMachineId);
    if(error){ toast("Erro ao salvar"); console.error(error); return; }
  }else{
    const { error } = await sb.from("machines").insert({ id: genId(), ...obj });
    if(error){ toast("Erro ao criar"); console.error(error); return; }
  }
  toast("M√°quina salva ‚úÖ");
  clearMachineForm();
  await loadMachines();
  renderMachinesTable();
  fillMachineSelectForUsers();
}

/* =======================
   ADMIN: USERS CRUD
   ======================= */
let editingUserId = null;

function fillMachineSelectForUsers(){
  const sel = $("u_machine");
  sel.innerHTML = `<option value="">‚Äî (nenhuma)</option>` + db.machines.map(m=>`<option value="${esc(m.id)}">${esc(m.name)}</option>`).join("");
}
function renderUsersTable(){
  $("users_body").innerHTML = db.users.map(u=>{
    const active = u.active ? "Sim" : "N√£o";
    const role = u.role === "admin" ? "Admin" : "Operador";
    return `
      <tr>
        <td><b>${esc(u.name)}</b></td>
        <td>${esc(u.username)}</td>
        <td><span class="badge">${esc(role)}</span></td>
        <td>${esc(active)}</td>
        <td>${esc(machineName(u.machine_id))}</td>
        <td>
          <button class="btn" type="button" onclick="editUser('${u.id}')">Editar</button>
          <button class="btn" type="button" onclick="resetUserPass('${u.id}')">Senha</button>
          <button class="btn danger" type="button" onclick="deleteUser('${u.id}')">Excluir</button>
        </td>
      </tr>
    `;
  }).join("") || `<tr><td colspan="6" class="muted">Sem usu√°rios cadastrados.</td></tr>`;
}
function clearUserForm(){
  editingUserId = null;
  $("u_name").value="";
  $("u_user").value="";
  $("u_pass").value="";
  $("u_role").value="operator";
  $("u_active").value="true";
  $("u_machine").value="";
}
function editUser(id){
  const u = findUserById(id);
  if(!u) return;
  editingUserId = id;
  $("u_name").value = u.name || "";
  $("u_user").value = u.username || "";
  $("u_pass").value = "";
  $("u_role").value = u.role || "operator";
  $("u_active").value = String(!!u.active);
  $("u_machine").value = u.machine_id || "";
  toast("Editando usu√°rio");
}
async function deleteUser(id){
  const u = findUserById(id);
  if(!u) return;
  if(u.username === "admin"){
    toast("N√£o √© permitido excluir o admin principal");
    return;
  }
  if(!confirm("Excluir este usu√°rio?")) return;
  const { error } = await sb.from("users").delete().eq("id", id);
  if(error){ toast("Erro ao excluir"); console.error(error); return; }
  await loadUsers();
  renderUsersTable();
  toast("Usu√°rio exclu√≠do");
}
async function resetUserPass(id){
  const u = findUserById(id);
  if(!u) return;
  const newPass = prompt("Digite a nova senha:", "");
  if(newPass === null) return;
  if(!newPass.trim()){ toast("Senha inv√°lida"); return; }
  const { error } = await sb.from("users").update({ password: newPass.trim() }).eq("id", id);
  if(error){ toast("Erro ao atualizar senha"); console.error(error); return; }
  await loadUsers();
  renderUsersTable();
  toast("Senha atualizada");
}
async function saveUser(){
  const name = $("u_name").value.trim();
  const username = $("u_user").value.trim();
  const pass = $("u_pass").value;
  const role = $("u_role").value;
  const active = ($("u_active").value === "true");
  const machineId = $("u_machine").value || null;

  if(!name){ toast("Informe o nome"); return; }
  if(!username){ toast("Informe o usu√°rio (login)"); return; }
  if(!editingUserId && !pass.trim()){ toast("Defina uma senha"); return; }

  const nu = normalizeLogin(username);

  const exists = db.users.find(u => normalizeLogin(u.username) === nu && u.id !== editingUserId);
  if(exists){
    toast("Usu√°rio (login) j√° existe (mesmo nome, s√≥ muda acento/caixa/espa√ßo)");
    return;
  }
  if(nu === "admin" && username !== "admin"){
    toast("Esse login conflita com 'admin'. Escolha outro.");
    return;
  }

  if(editingUserId){
    const obj = {
      name,
      username,
      role,
      active,
      machine_id: (role==="operator") ? machineId : null
    };
    if(pass.trim()) obj.password = pass.trim();
    const { error } = await sb.from("users").update(obj).eq("id", editingUserId);
    if(error){ toast("Erro ao salvar usu√°rio"); console.error(error); return; }
  }else{
    const { error } = await sb.from("users").insert({
      id: genId(),
      name,
      username,
      password: pass.trim(),
      role,
      active,
      machine_id: (role==="operator") ? machineId : null
    });
    if(error){ toast("Erro ao criar usu√°rio"); console.error(error); return; }
  }

  await loadUsers();
  clearUserForm();
  renderUsersTable();
  toast("Usu√°rio salvo ‚úÖ");
}

/* =======================
   ADMIN: RECORDS
   ======================= */
function getMachineNameFromRecordRow(row){
  const r = row.data;
  return r?.machineName || row.machine_name || machineName(row.machine_id) || "‚Äî";
}
async function renderRecordsTable(){
  const from = $("rep_from").value || "0000-01-01";
  const to = $("rep_to").value || "9999-12-31";

  const { data, error } = await sb.from("records")
    .select("*")
    .gte("date", from)
    .lte("date", to)
    .order("date", {ascending:false});
  if(error){ toast("Erro ao buscar registros"); console.error(error); return; }

  const rows = data || [];
  $("rep_body").innerHTML = rows.map(row=>{
    const r = row.data || {};
    const hrs = Number(row.hours_worked||0).toFixed(1);
    const fuel = (Number(row.fuel_liters||0) > 0) ? `${row.fuel_liters} L` : "‚Äî";
    const av = row.avaria_severity || "‚Äî";
    return `
      <tr>
        <td><b>${esc(row.date)}</b></td>
        <td>${esc(getMachineNameFromRecordRow(row))}</td>
        <td>${esc(r.operatorName || row.operator_name || "‚Äî")}</td>
        <td>${esc(formatDemand(r.demand, null))}</td>
        <td>${esc(hrs)}</td>
        <td>${esc(fuel)}</td>
        <td>${esc(av)}</td>
        <td>
          <button class="btn" type="button" onclick="viewRecord('${row.id}')">Ver</button>
          <button class="btn danger" type="button" onclick="deleteRecord('${row.id}')">Apagar</button>
        </td>
      </tr>
    `;
  }).join("") || `<tr><td colspan="8" class="muted">Sem registros no per√≠odo.</td></tr>`;
}
async function deleteRecord(id){
  if(!confirm("Apagar este registro?")) return;
  const { error } = await sb.from("records").delete().eq("id", id);
  if(error){ toast("Erro ao apagar"); console.error(error); return; }
  toast("Registro apagado");
  await renderRecordsTable();
  await refreshAdmin();
}

/* =======================
   MODAL
   ======================= */
function openModal(title, sub, html){
  $("modalTitle").textContent = title;
  $("modalSub").textContent = sub || "";
  $("modalBody").innerHTML = html || "";
  $("modalBack").style.display = "flex";
}
function closeModal(){ $("modalBack").style.display = "none"; }
$("btnModalClose").onclick = closeModal;
$("modalBack").onclick = (e)=>{ if(e.target.id==="modalBack") closeModal(); };

async function viewRecord(id){
  const { data, error } = await sb.from("records").select("*").eq("id", id).maybeSingle();
  if(error || !data){ toast("Registro n√£o encontrado"); return; }
  const r = data.data || {};

  const av = r.avaria;
  const fu = r.fuel;

  const photos = [];
  if(r.hmStartPhoto) photos.push({label:"Hor√≠metro inicial", src:r.hmStartPhoto});
  if(r.hmEndPhoto) photos.push({label:"Hor√≠metro final", src:r.hmEndPhoto});
  if(av?.photo) photos.push({label:"Avaria", src:av.photo});
  if(fu?.photo) photos.push({label:"Nota/abastecimento", src:fu.photo});

  const photoHTML = photos.length ? `
    <div class="divider"></div>
    <h2>Fotos</h2>
    <div class="preview">
      ${photos.map(p=>`<div style="width:140px">
        <div class="muted" style="margin-bottom:6px"><b>${esc(p.label)}</b></div>
        <img src="${p.src}" style="width:140px;height:100px;object-fit:cover;border-radius:12px;border:1px solid var(--line)"/>
      </div>`).join("")}
    </div>
  ` : "";

  const html = `
    <div class="notice">
      <b>Data:</b> ${esc(r.date)}<br>
      <b>M√°quina:</b> ${esc(r.machineName || "‚Äî")}<br>
      <b>Operador:</b> ${esc(r.operatorName || "‚Äî")}<br>
      <b>Demanda:</b> ${esc(formatDemand(r.demand, null))}
    </div>

    <div class="divider"></div>
    <h2>Hor√≠metro / Horas</h2>
    <div class="notice">
      <b>Inicial:</b> ${esc(r.hmStart)}<br>
      <b>Final:</b> ${esc(r.hmEnd)}<br>
      <b>Horas trabalhadas:</b> ${esc(r.hoursWorked)}<br>
      <b>Paradas:</b> ${esc(r.hoursStopped)} ${r.stopReason ? `‚Ä¢ ${esc(r.stopReason)} ${esc(r.stopDetail||"")}`:""}
    </div>

    ${r.dayNotes ? `<div class="divider"></div><h2>Observa√ß√µes do dia</h2><div class="notice">${esc(r.dayNotes).replaceAll("\n","<br>")}</div>`:""}

    <div class="divider"></div>
    <h2>Avaria</h2>
    <div class="notice">
      ${av ? `
        <b>Categoria:</b> ${esc(av.category)}<br>
        <b>Gravidade:</b> ${esc(av.severity)}<br>
        <b>Pode operar:</b> ${esc(av.canOperate)}<br>
        <b>J√° vinha de antes:</b> ${esc(av.previous)}<br>
        <b>Descri√ß√£o:</b> ${esc(av.desc).replaceAll("\n","<br>")}
      ` : "Nenhuma"}
    </div>

    <div class="divider"></div>
    <h2>Abastecimento</h2>
    <div class="notice">
      ${fu?.yes ? `
        <b>Tipo:</b> ${esc(fu.type)}<br>
        <b>Litros:</b> ${esc(fu.liters)}<br>
        <b>Total:</b> R$ ${esc(Number(fu.total).toFixed(2))}<br>
        <b>R$/L:</b> ${esc(fu.pricePerLiter)}<br>
        <b>L/h:</b> ${esc(fu.lph)}<br>
        <b>Quem:</b> ${esc(fu.who)}
      ` : "N√£o abasteceu"}
    </div>

    ${photoHTML}
  `;
  openModal("Registro", `${r.machineName || "‚Äî"} ‚Ä¢ ${r.operatorName || "‚Äî"}`, html);
}

/* =======================
   EXPORT CSV
   ======================= */
function csvCell(v){
  const s = (v===null || v===undefined) ? "" : String(v);
  if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}
function downloadText(text, filename, mime){
  const blob = new Blob([text], {type: mime || "text/plain"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
}
async function exportCSV(){
  const { data, error } = await sb.from("records").select("*").order("date", {ascending:true});
  if(error){ toast("Erro ao exportar"); console.error(error); return; }

  const header = [
    "id","date","machine","operator","username",
    "demand_type","obra_name","obra_location","client","loc_location",
    "hm_start","hm_end","hours_worked","hours_stopped","stop_reason","stop_detail","day_notes",
    "fuel_yes","fuel_type","fuel_liters","fuel_total","fuel_price_per_liter","fuel_lph","fuel_who",
    "avaria_yes","av_cat","av_sev","av_can_operate","av_previous","av_desc"
  ];
  const lines = [header.join(",")];

  (data||[]).forEach(row=>{
    const r = row.data || {};
    const dem = r.demand || {};
    const fu = r.fuel || {};
    const av = r.avaria || {};
    lines.push([
      row.id, row.date, r.machineName||row.machine_name||"", r.operatorName||row.operator_name||"", row.username,
      dem.type||"", dem.obraName||"", dem.obraLocation||"", dem.client||"", dem.location||"",
      r.hmStart??"", r.hmEnd??"", r.hoursWorked??"", r.hoursStopped??"", r.stopReason||"", r.stopDetail??"", r.dayNotes??"",
      fu.yes ? "sim" : "nao", fu.type||"", fu.liters??"", fu.total??"", fu.pricePerLiter??"", fu.lph??"", fu.who||"",
      r.avaria ? "sim" : "nao", av.category||"", av.severity||"", av.canOperate||"", av.previous||"", av.desc||""
    ].map(csvCell).join(","));
  });

  downloadText(lines.join("\n"), `diario_maquinas_${todayStr()}.csv`, "text/csv;charset=utf-8");
  toast("CSV exportado ‚úÖ");
}

/* =======================
   ADMIN: REFRESH ALL
   ======================= */
async function refreshAllAdminData(){
  await loadMachines();
  await loadUsers();
}

/* =======================
   LOGIN / LOGOUT
   ======================= */
async function doLogin(){
  const usernameRaw = $("loginUser").value.trim();
  const pass = $("loginPass").value;
  if(!usernameRaw || !pass){ toast("Preencha usu√°rio e senha"); return; }

  await refreshAllAdminData();

  const user = findUserByUsername(usernameRaw);
  if(!user){ toast("Usu√°rio n√£o encontrado"); return; }
  if(!user.active){ toast("Usu√°rio inativo"); return; }
  if(String(user.password||"") !== String(pass||"")){ toast("Senha incorreta"); return; }

  session = { username: user.username, role: user.role };
  $("pillName").textContent = user.name || user.username;

  if($("keepLogged").value === "sim") saveSession();
  else clearSession();

  if(session.role === "admin"){
    showAdmin();
    setupAdminTabs();
    $("ad_from").value = todayStr();
    $("ad_to").value = todayStr();
    $("rep_from").value = todayStr();
    $("rep_to").value = todayStr();
    await refreshAdmin();
    $("adminConn").textContent = "Conex√£o: OK ‚úÖ";
    attachRealtimeSubscriptions();
  }else{
    showOperator();
    await initOperator();
    attachRealtimeSubscriptions();
  }

  toast("Entrou ‚úÖ");
}
function logout(){
  session = { username:null, role:null };
  clearSession();
  showLogin();
  toast("Saiu");
}

/* =======================
   REALTIME (SINCRONIZA√á√ÉO)
   ======================= */
let rtChannel = null;

function attachRealtimeSubscriptions(){
  try{
    if(rtChannel){
      sb.removeChannel(rtChannel);
      rtChannel = null;
    }
  }catch(e){}

  rtChannel = sb.channel("diario_realtime_v1");

  rtChannel.on("postgres_changes", { event:"*", schema:"public", table:"machines" }, async () => {
    await loadMachines();
    if(session.role === "admin"){
      renderMachinesTable();
      fillMachineSelectForUsers();
      await renderMachineStatusTable();
      await refreshAdmin();
    }else{
      await loadUsers();
      const u = findUserByUsername(session.username);
      if(u){
        $("opInfo").innerHTML =
          `<b>Operador:</b> ${esc(u.name)}<br><b>M√°quina:</b> ${esc(machineName(u.machine_id))}`;
      }
      updateHomeCards();
    }
  });

  rtChannel.on("postgres_changes", { event:"*", schema:"public", table:"users" }, async () => {
    await loadUsers();
    if(session.role === "admin"){
      renderUsersTable();
      fillMachineSelectForUsers();
    }else{
      const u = findUserByUsername(session.username);
      if(!u || !u.active){
        toast("Seu usu√°rio foi desativado. Saindo‚Ä¶");
        logout();
        return;
      }
      $("pillName").textContent = u.name || u.username;
      $("opInfo").innerHTML =
        `<b>Operador:</b> ${esc(u.name)}<br><b>M√°quina:</b> ${esc(machineName(u.machine_id))}`;
      updateHomeCards();
    }
  });

  rtChannel.on("postgres_changes", { event:"*", schema:"public", table:"drafts" }, async (payload) => {
    const row = payload?.new || payload?.old;
    if(!row) return;

    if(session.role === "admin"){
      await renderMachineStatusTable();
      await refreshAdmin();
    }else{
      if(row.username === session.username && row.date === $("opDate").value){
        await loadDraftToUIIfExists();
        updateHomeCards();
      }
    }
  });

  rtChannel.on("postgres_changes", { event:"*", schema:"public", table:"records" }, async () => {
    if(session.role === "admin"){
      await renderMachineStatusTable();
      await refreshAdmin();
      const tabActive = document.querySelector(".tab.active")?.dataset?.tab;
      if(tabActive === "records"){
        await renderRecordsTable();
      }
    }
  });

  rtChannel.subscribe((status) => {
    const ok = (status === "SUBSCRIBED");
    if(session.role === "admin"){
      $("adminConn").textContent = ok ? "Conex√£o: RealTime OK ‚úÖ" : `Conex√£o: ${status}`;
    }else{
      $("connState").textContent = ok ? "Conex√£o: RealTime OK ‚úÖ" : `Conex√£o: ${status}`;
    }
  });
}

/* =======================
   EVENTOS UI
   ======================= */
$("btnLogin").onclick = doLogin;
$("btnLogout").onclick = logout;

$("demandType").onchange = updateDemandTypeUI;
$("btnSaveDemand").onclick = saveDemand;
$("btnCloseRental").onclick = closeRentalUI;

$("btnStartShift").onclick = startShift;
$("btnFinishShift").onclick = finishShift;

$("btnBackHome1").onclick = goHome;
$("btnBackHome2").onclick = goHome;
$("btnBackHome3").onclick = goHome;

$("goDemand").onclick = ()=>{ goDemand(); };
$("goStart").onclick = ()=>{ goStart(); };
$("goEnd").onclick = ()=>{ goEnd(); };

$("usePrevDemand").onchange = async ()=>{
  const prev = db.demandByUser[session.username] || null;
  if($("usePrevDemand").value==="sim" && prev){
    setDemandUI(prev);
  }else{
    setDemandUI(null);
  }
};

$("btnUsePrev").onclick = ()=>{
  const prev = db.demandByUser[session.username] || null;
  if(prev) setDemandUI(prev);
};
$("btnNewDemand").onclick = ()=> setDemandUI(null);

$("hasAvaria").onchange = ()=>{
  const en = ($("hasAvaria").value === "sim");
  setAvariaEnabled(en);
};

$("fuel_yes").onchange = ()=>{
  setFuelBlockVisible();
  calcFuel();
};
$("fuel_liters").oninput = calcFuel;
$("fuel_total").oninput = calcFuel;
$("hm_end").oninput = ()=>{
  calcHours();
  calcFuel();
};

$("opDate").onchange = async ()=>{
  await loadDraftToUIIfExists();
  updateTurnInfo();
  updateHomeCards();
  goHome();
};

$("hm_start_photo").onchange = async ()=>{
  const f = $("hm_start_photo").files?.[0] || null;
  const data = f ? await fileToCompressedDataURL(f) : null;
  showPreview("hm_start_preview", data);
};
$("av_photo").onchange = async ()=>{
  const f = $("av_photo").files?.[0] || null;
  const data = f ? await fileToCompressedDataURL(f) : null;
  showPreview("av_preview", data);
};
$("hm_end_photo").onchange = async ()=>{
  const f = $("hm_end_photo").files?.[0] || null;
  const data = f ? await fileToCompressedDataURL(f) : null;
  showPreview("hm_end_preview", data);
};
$("fuel_photo").onchange = async ()=>{
  const f = $("fuel_photo").files?.[0] || null;
  const data = f ? await fileToCompressedDataURL(f) : null;
  showPreview("fuel_preview", data);
};

// Admin buttons
$("btnMachineClear").onclick = clearMachineForm;
$("btnMachineSave").onclick = saveMachine;

$("btnUserClear").onclick = clearUserForm;
$("btnUserSave").onclick = saveUser;

$("btnApplyFilters").onclick = renderRecordsTable;
$("btnExportCSV").onclick = exportCSV;

$("btnRefreshAdmin").onclick = refreshAdmin;
$("btnForceRefresh").onclick = async ()=>{
  await refreshAllAdminData();
  await refreshAdmin();
  toast("Atualizado do banco ‚úÖ");
};

/* Expor fun√ß√µes pro onclick das tabelas */
window.editMachine = editMachine;
window.deleteMachine = deleteMachine;
window.editUser = editUser;
window.resetUserPass = resetUserPass;
window.deleteUser = deleteUser;
window.viewRecord = viewRecord;
window.deleteRecord = deleteRecord;

/* =======================
   INIT
   ======================= */
(async function boot(){
  showLogin();

  try{
    const ok = await pingSupabase();
    $("connState").textContent = ok ? "Conex√£o: OK ‚úÖ" : "Conex√£o: Falhou";
  }catch(e){
    $("connState").textContent = "Conex√£o: Erro";
  }

  const saved = loadSession();
  if(saved?.username){
    session = saved;
    $("loginUser").value = saved.username;
  }
})();
</script>
</body>
</html>
